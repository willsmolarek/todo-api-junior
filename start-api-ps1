# start-api.ps1 - Script para iniciar API Todo
Write-Host "=== INICIANDO API TODO ===" -ForegroundColor Cyan

# 1. Verificar se temos arquivo principal
Write-Host "`n1. Procurando arquivo principal..." -ForegroundColor Yellow

$mainFile = $null
$possibleFiles = @("server.js", "app.js", "dist/server.js", "dist/app.js", "src/server.ts", "src/app.ts")

foreach ($file in $possibleFiles) {
    if (Test-Path $file) {
        Write-Host "   ‚úÖ Encontrado: $file" -ForegroundColor Green
        $mainFile = $file
        break
    }
}

# Se n√£o encontrou, criar server.js b√°sico
if (-not $mainFile) {
    Write-Host "   ‚ö†Ô∏è  Nenhum arquivo encontrado. Criando server.js b√°sico..." -ForegroundColor Yellow
    
    @'
// server.js - API Todo b√°sica para testes
const express = require("express");
const app = express();

// Middlewares b√°sicos
app.use(require("cors")());
app.use(express.json());

// Rota raiz (ESSENCIAL)
app.get("/", (req, res) => {
    res.json({
        message: "üöÄ Todo API - Online!",
        status: "online",
        version: "1.0.0",
        author: "Willian Smolarek",
        endpoints: [
            "GET  /          ‚Üí Esta mensagem",
            "GET  /health    ‚Üí Status da API",
            "GET  /tasks     ‚Üí Lista de tarefas",
            "POST /tasks     ‚Üí Criar tarefa",
            "GET  /tasks/:id ‚Üí Buscar tarefa",
            "PUT  /tasks/:id ‚Üí Atualizar tarefa",
            "DELETE /tasks/:id ‚Üí Remover tarefa"
        ]
    });
});

// Health check (ESSENCIAL para Render/testes)
app.get("/health", (req, res) => {
    res.json({
        status: "OK",
        message: "API is running",
        timestamp: new Date().toISOString()
    });
});

// Mock de tasks para demonstra√ß√£o
const tasks = [
    {
        id: "1",
        title: "Configurar servidor API",
        description: "Configurar Express e rotas b√°sicas",
        status: "COMPLETED",
        priority: "HIGH"
    },
    {
        id: "2",
        title: "Testar endpoints REST",
        description: "Testar GET, POST, PUT, DELETE",
        status: "IN_PROGRESS",
        priority: "MEDIUM"
    }
];

// GET /tasks
app.get("/tasks", (req, res) => {
    res.json({
        success: true,
        data: tasks,
        count: tasks.length,
        message: "Tasks retrieved successfully"
    });
});

// POST /tasks
app.post("/tasks", (req, res) => {
    const newTask = {
        id: (tasks.length + 1).toString(),
        title: req.body.title || "Nova tarefa",
        description: req.body.description || "",
        status: "PENDING",
        priority: req.body.priority || "MEDIUM",
        createdAt: new Date().toISOString()
    };
    
    tasks.push(newTask);
    
    res.status(201).json({
        success: true,
        data: newTask,
        message: "Task created successfully"
    });
});

// Porta
const PORT = process.env.PORT || 3000;

app.listen(PORT, "0.0.0.0", () => {
    console.log("=" . 50);
    console.log("üöÄ SERVIDOR INICIADO COM SUCESSO!");
    console.log("=" . 50);
    console.log(`üì° Porta: ${PORT}`);
    console.log(`üåê Ambiente: ${process.env.NODE_ENV || "development"}`);
    console.log(`üîó URL local: http://localhost:${PORT}`);
    console.log(`üè• Health check: http://localhost:${PORT}/health`);
    console.log("=" . 50);
    console.log("Pressione Ctrl+C para parar");
    console.log("=" . 50);
});

module.exports = app;
'@ | Set-Content -Path server.js -Encoding UTF8
    
    $mainFile = "server.js"
    Write-Host "   ‚úÖ server.js criado!" -ForegroundColor Green
}

# 2. Verificar depend√™ncias
Write-Host "`n2. Verificando depend√™ncias..." -ForegroundColor Yellow

# Verificar package.json
if (Test-Path package.json) {
    try {
        $pkg = Get-Content package.json -Raw | ConvertFrom-Json
        $hasExpress = $pkg.dependencies.PSObject.Properties.Name -contains "express"
        
        if ($hasExpress) {
            Write-Host "   ‚úÖ Express encontrado no package.json" -ForegroundColor Green
        } else {
            Write-Host "   ‚ö†Ô∏è  Express n√£o listado, adicionando..." -ForegroundColor Yellow
            
            # Adicionar ao package.json
            if (-not $pkg.dependencies) { $pkg.dependencies = @{} }
            $pkg.dependencies.express = "^4.18.0"
            $pkg.dependencies.cors = "^2.8.5"
            
            $pkg | ConvertTo-Json -Depth 10 | Out-File package.json -Encoding UTF8
            Write-Host "   ‚úÖ Depend√™ncias adicionadas" -ForegroundColor Green
        }
    } catch {
        Write-Host "   ‚ö†Ô∏è  Erro ao ler package.json" -ForegroundColor Yellow
    }
} else {
    Write-Host "   ‚ö†Ô∏è  package.json n√£o encontrado. Criando..." -ForegroundColor Yellow
    
    @'
{
  "name": "todo-api-junior",
  "version": "1.0.0",
  "description": "API de Tarefas",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "node server.js"
  },
  "dependencies": {
    "express": "^4.18.0",
    "cors": "^2.8.5"
  }
}
'@ | Set-Content -Path package.json -Encoding UTF8
    
    Write-Host "   ‚úÖ package.json criado!" -ForegroundColor Green
}

# 3. Instalar/verificar node_modules
Write-Host "`n3. Verificando node_modules..." -ForegroundColor Yellow

if (-not (Test-Path node_modules)) {
    Write-Host "   ‚ö†Ô∏è  node_modules n√£o encontrado. Instalando..." -ForegroundColor Yellow
    npm install
} else {
    Write-Host "   ‚úÖ node_modules encontrado" -ForegroundColor Green
}

# 4. Iniciar servidor
Write-Host "`n4. üöÄ INICIANDO SERVIDOR..." -ForegroundColor Green -BackgroundColor DarkBlue
Write-Host "   Arquivo: $mainFile" -ForegroundColor Cyan
Write-Host "   Porta: 3000" -ForegroundColor Cyan
Write-Host "   URL: http://localhost:3000" -ForegroundColor Cyan
Write-Host "`n" + "="*50 -ForegroundColor Cyan
Write-Host "Pressione Ctrl+C para parar o servidor" -ForegroundColor Yellow
Write-Host "="*50 -ForegroundColor Cyan
Write-Host "`n"

# Iniciar
node $mainFile